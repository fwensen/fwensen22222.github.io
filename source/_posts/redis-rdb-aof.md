---
title: RDB持久化和AOF持久化
date: 2017-04-28 23:19:41
tags: Redis
categories: Redis
---
### 一. RDB持久化  
未解决一旦服务器进程退出，服务器中的数据库状态(方便起见，服务器中的非空数据库以及它们的键值对统称数据库状态)也会消失不见的问题，Redis提供了RDB持久化功能，这个功能可以将Redis在内存中的数据库状态保存到磁盘里面，避免数据意外丢失。  
#### 1. RDB文件的创建和载入  
- SAVE与BGSAVE命令用于生成RDB文件，不同在于**前者会阻塞Redis服务器进程**，直到RDB文件创建完毕为止；而后者则是派生出一个子进程，然后由子进程负责创建RDB文件；  
- 服务器在启动时若检测到RDB文件存在，它就会自动载入RDB文件，但有以下条件；  
- 如果服务器开启了AO持久化功能，那么服务器会优先使用AOF文件来还原数据库状态，**只有在AOF持久化功能处于关闭时**，服务器才使用RDB文件来还原数据库状态；  
- 当服务器在执行SAVE命令时，客户端发送的所有命令请求都会被拒绝；  
- BGSAVE命令执行期间，客户端发送的SAVE命令会被服务器拒绝；在BGSAVE命令执行期间，客户端发送的BGSAVE命令会被服务器拒绝；BGREWRITEAOF和BGSAVE两个命令不能同时执行；  
- 自动间隔性保存：  
    1. Redis允许用户配置服务器配置的save选项，**让服务器每隔一段时间自动执行一次BGSAVE命令**； 例如save 200 1表示服务器在900秒之内，对数据库进行了至少一次修改；  
    2. 服务器实现自动保存的数据结构为saveparam结构体，服务器的周期性操作函数serverCron默认每隔100毫秒执行一次，其中一项工作就是检查save选项所设置的保存条件是否已经满足，如果满足的话，就执行BGSAVE命令；   
- 服务器状态维持了一个dirty计数器和一个lastsave属性：  
    - dirty计数器记录距离上次成功执行SAVE或BGSAVE命令后，服务器对服务器状态进行了多少次修改；  
    - lastsave属性是一个unix时间戳，记录了服务器上一次成功执行SAVE或BGSAVE命令的时间。  

![](http://note.youdao.com/yws/public/resource/12eeca1b84ec5008b7c369d478db936a/xmlnote/C5BFD7897B874A94AD8F232BC9D235C7/7565)  


### 2. AOF持久化  
与RDB文件不同，AOF是通过保存Redis**服务器所执行的==写命令==**来记录数据库状态的。  
1. AOF持久化功能的实现可分为命令追加、文件写入和文件同步：  
    - 命令追加：当AOF持久化功能处于打开状态时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓冲区的末尾；  
    - 写入与同步：因为服务器在处理文件事件时(一些网络读写等事件)可能会执行写命令，使得一些内容被追加到aof_buf区里面，所以服务器每次结束一个事件循环之前，它都会调用flushAppendOnly函数，考虑是否需要将aof_buf中的内容写入和保存到AOF文件里，该函数的行为由服务器配置的appendfsync选项设定，有alays、everysec和no三个选项。  
2. AOF文件的载入与还原：因为AOF文件里面包括了重建数据状态所需的所有写命令，所以服务器只要重新执行一遍AOF文件里面保存的写命令，就可以还原服务器关闭之前的数据库状态，具体步骤如下：  
    1. 创建一个**不带网络连接的伪客户端**，用于执行AOF文件中的命令；  
    2. 从AOF文件中分析并读取出一条写命令；  
    3. 使用伪客户端执行被读出的写命令；  
    4. 一直执行步骤2、3.  
3. AOF重写：为解决AOF文件膨胀得问题，提供了AOF文件重写功能，该功能中，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧AOF文件所保存的数据库状态相同，但新AOF文件不会包含任何浪费空间的冗余。  
4. AOF重写并不需要对现有的AOF文件进行任何读取、分析或者写入操作，而是通过读取服务器当前的数据库状态来实现的，  

![](http://note.youdao.com/yws/public/resource/12eeca1b84ec5008b7c369d478db936a/xmlnote/B1494FE574734190A71180E9A5BBB1D2/7621)  
