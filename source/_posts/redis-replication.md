---
title: redis复制
date: 2017-04-29 23:19:48
tags: Redis
categories: Redis
---

> 用户通过执行SLAVEOF命令或设置slaveof选项，让一个服务器去复制另一个服务器，则被复制的服务器为主服务器，而对主服务器进行复制的为从服务器。  

### 1. 旧版复制功能的实现  
复制功能包括两个：同步和命令传播。  
- 同步操作作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态；  
- 命令传播操作则是同于在主服务器的数据库状态被修改，导致主从服务器的数据库状态处于不一致时，让主从服务器的数据库重新回到一致状态。  

1. 从服务器通过发送SYNC来同步主服务器，其主要步骤包括：  
    1. 从服务器向主服务器发送SYNC命令；  
    2. 收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，用一个缓冲区记录从现在开始执行的所有写命令；  
    3. 当主服务器的BGSAVE命令执行完成时，主服务器会将生成的RDB文件发送给从服务器，从服务器接收并载入该文件，将自己的数据库状态更新至主服务器的状态；  
    4. 主服务器将缓冲区中所有的写命令发送给从服务器，从服务器执行这些写命令。  
2. 传播命令  

在同步完成之后，主从服务器达到一致状态，但在后面的运行中，可能由于主服务器的写而造成主从不一致，所以有命令传播的步骤。命令传播中，主服务器会将自己执行的写命令，也即是造成主从服务器不一致的那条写命令，发送给从服务器执行，当从服务器执行了相同的写命令后，主从服务器将再次回到一致状态。  

3. 旧版复制功能的缺陷  
在从服务器断线后重连时，从服务器会使用SYNC命令与主服务器进行同步，而这时主服务器将**生成所有数据的RDB文件发送给从服务器，这就会造成从服务器数据大量的重复，同时增加了通信的负担**，所以这里是旧版复制的缺陷。  

### 2. 新版复制功能  
从2.8版本后，使用PSYNC命令代替SYNC命令来执行复制时的同步操作。  
PSYNC命令具有完整重同步和部分重同步两种模式：  
- 完整重同步用于处理初次复制情况：与SYNC命令步骤基本一致，它们都会让主服务器生成RDB文件，以及主服务器发送保存在缓冲区里面的写命令来进行同步；  
- 部分重同步则用于处理断线后重复制的情况：断线重连后，主服务器只会向从服务器发送断线期间执行的写命令，从服务器只要接收并执行这些写命令即可。  

1. 部分重同步的实现  
实现有三部分构成：  
- 主服务器的复制偏移量和从服务器的复制偏移量；  
- 主服务器的复制积压缓冲区；  
- 服务器的运行ID。  

1）复制偏移量  
执行复制的双方分别维护一个复制偏移量：  
- 主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量值加N；  
- 从服务器每次收到主服务器传播的N个字节数据时，就将自己的复制偏移量值加上N。  

所以通过对比主从服务器的偏移量，就可以很容易的知道主从服务器是否处于一致状态。   

2）复制积压缓冲区  
复制积压缓冲区是由主服务器维护的一个固定长度的FIFO队列，默认大小为1MB。  
当主服务器进行命令传播时，它不仅会将写命令发送给所有的从服务器，还会将写命令入队到复制积压缓冲区里面。并且复制积压缓冲区会为队列的每个字节记录相应的复制偏移量。  

每当从服务器断线后重连上主服务器时，从服务器通过PSYNC命令将自己的复制偏移量offset发送给主服务器，主服务器根据这个复制偏移量来决定对从服务器执行何种同步操作：
- 如果offset偏移量之后的数据仍然在复制积压缓冲区里面，那么主服务器将对从服务器执行部分重同步操作；  
- 否则会执行完整重同步操作。  

3）服务器运行ID  
> 每个Redis服务器，不论主服务器还是从服务器，都会有自己的运行ID；
> 运行ID在服务器启动时自动生成，由40个随机的十六进制字符组成。  

1. 当从服务器进行初次复制时，主服务器将自己的运行ID传送给从服务器，而从服务器则会将这个运行ID保存起来。  
2. 在从服务器断线重连后，从服务器将向当前连接的主服务器发送之前保存的运行ID：
    - 如果从服务器保存的运行ID和当前连接的主服务器ID相同，那么说明从服务器断线之前复制的就是当前连接的这个主服务器，主服务器可以继续尝试执行部分重同步操作；  
    - 否则，它们不是同一个主服务器，这时主服务器将对从服务器执行完整重同步操作。  
